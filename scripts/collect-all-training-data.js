/**
 * ì—¬ëŸ¬ cust_idì˜ ëª¨ë“  í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸
 * ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‹¤í–‰
 */

// í•œêµ­ ìœ ì € cust_id ëª©ë¡
const KOREAN_USER_IDS = [
  '309265', '262743', '581167', '285643', '260023', '549448', '884271', '883055', '650982', '107331',
  '336097', '471469', '107816', '903646', '814119', '590617', '224144', '417925', '947752', '600760',
  '425681', '964014', '632153', '702516', '638599', '533283', '414449', '577311', '817684', '355110',
  '844744', '930741', '812314', '316344', '430658', '936122', '716643', '102744', '148593', '535865',
  '1025245', '846096', '663317', '1036658', '1028659', '811279', '110930', '819718', '417749', '906414',
  '841121', '282201', '614365', '648753', '859853', '1054479', '1064680', '871692', '733369', '365321',
  '440330', '431811', '705999', '353365', '969036', '717534', '848332', '949948', '1066763', '438592',
  '541844', '800460', '1048606', '679752', '995822', '552900', '898019', '954473', '106690', '228705',
  '724754', '966322', '829867', '961585', '979786', '1066336', '984656', '637677', '839986', '768983',
  '873713', '963377', '710671', '1046008', '1029692', '955141', '805383', '594593', '941440', '855788',
  '671236', '659869', '1038205', '909017', '990852', '974872', '1053384', '971967', '228473', '757861',
  '771436', '1063069', '978308', '902598', '1042604', '586983', '1046812', '1018543', '817891', '971352',
  '840488', '964045', '627117', '809928', '100162', '1003499', '1052310', '899425', '816813', '964788',
  '837855', '211239', '937099', '849120', '633475', '600294', '782112', '1043091', '979493', '558603',
  '968014', '831485', '835940', '658416', '912255', '897258', '1051956', '768612', '174654', '815933',
  '1060971', '588562', '605055', '648627', '901186', '738115', '784562', '969110', '855658', '825315',
  '1006852', '185584', '129537', '965781', '959623', '973569', '984790', '141034', '974867', '413967',
  '775945', '819288', '138870', '695170', '936457', '1008408', '938054', '999987', '1055250', '897720',
  '776907', '898566', '767189', '1027926', '779083', '1011765', '1059270', '1064270', '868660', '139323',
  '972508', '230686', '171687', '420569', '593896', '968354', '998897', '1015019', '726262', '869863',
  '1043106', '838741', '1048357', '1040317', '1045153', '813220', '650385', '1046359', '1066920', '1050695',
  '881100', '1059671', '969000', '1038236', '991419', '1059504', '823136', '1062432', '1023959', '723090',
  '996361', '1012824', '491771', '760674', '661315', '995826', '975604', '1039218', '1051090', '984680',
  '642682', '627063', '656225', '867250', '1059542', '937912', '1048833', '998059', '1008386', '784959',
  '916988', '552658', '877703', '772662', '962389', '778809', '277376', '927579', '945515', '115370',
  '1023942', '748458', '772118', '890412', '603545', '858313', '971090', '627164', '1019474', '1031411',
  '1017715', '626610', '821248', '1064283', '715161', '957204', '1053071', '1055537', '445685', '1043460',
  '1009829', '937918', '973522', '1046503', '1044001', '842715', '785788', '815353', '954325', '1057896',
  '730249', '1026518', '1054954', '748932', '983159', '1067343', '949295', '947879', '608141', '544144',
  '673579', '732513', '1052264', '974953', '866245', '974842', '1018150', '1059626', '906630', '962460',
  '758781', '978787', '964806', '963982', '934801', '1007457', '321235', '867003', '138275', '691858',
  '841993', '425321', '935349', '390448', '1047624', '735960', '1027260', '769051', '649891', '1051112',
  '564581', '943318', '1019012', '870278', '995206', '629930', '1020731', '957791', '1006368', '1067427',
  '805399', '1067317', '1066888', '1001837', '1067251', '1067384', '1068574', '1068360', '1064245', '1059115',
  '504143', '927058', '1065965', '1065443', '1059524', '1063606', '1065433', '684958', '1065469', '816904',
  '1063183', '1062735', '924304', '1061975', '1057884', '1058814', '650958', '1000038', '1059580', '1059849',
  '1058377', '1060072', '1057768', '1055528', '1049590', '676708', '892571', '993840', '1029829', '1054937',
  '1049478', '1054943', '1054488', '939128', '969249', '1046204', '1050661', '1048883', '1048286', '1045045',
  '726418', '1048336', '1041182', '1048650', '1042535', '211376', '1013888', '1045901', '1044714', '1039730',
  '803337', '1041765', '1042144', '1037766', '984660', '1038220', '980442', '101110', '1037295', '1036706',
  '1036667', '1036084', '1036761', '1029745', '1002919', '1030689', '1032851', '1028539', '1009172', '1006437',
  '1025426', '658769', '994470', '1022739', '1027910', '971593', '1018153', '924624', '634079', '1016154',
  '1014017', '719993', '1018565'
]

/**
 * ë‹¨ì¼ cust_idì˜ ì„¸ì…˜ ID ìˆ˜ì§‘
 */
async function getSessionIdsForCustId(custId, limit = 50) {
  try {
    const res = await fetch(`/api/iracing/ml/get-recent-session-ids?cust_id=${custId}&limit=${limit}`)
    const data = await res.json()
    return data.sessionIds || []
  } catch (error) {
    console.error(`  âŒ cust_id ${custId} ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error)
    return []
  }
}

/**
 * ì—¬ëŸ¬ cust_idì˜ ëª¨ë“  í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘
 */
async function collectAllTrainingData(custIds = KOREAN_USER_IDS, batchSize = 5, sessionLimitPerUser = 50) {
  console.log(`ğŸš€ [ì „ì²´ ìˆ˜ì§‘ ì‹œì‘]`)
  console.log(`   ì´ cust_id: ${custIds.length}ê°œ`)
  console.log(`   ë°°ì¹˜ í¬ê¸°: ${batchSize}ê°œ`)
  console.log(`   ìœ ì €ë‹¹ ì„¸ì…˜ ì œí•œ: ${sessionLimitPerUser}ê°œ`)
  
  const allSessionIds = new Set() // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ Set ì‚¬ìš©
  const custIdStats = {}
  
  // 1. ëª¨ë“  cust_idì˜ ì„¸ì…˜ ID ìˆ˜ì§‘
  console.log(`\nğŸ“¥ [1ë‹¨ê³„] ëª¨ë“  cust_idì˜ ì„¸ì…˜ ID ìˆ˜ì§‘ ì¤‘...`)
  for (let i = 0; i < custIds.length; i++) {
    const custId = String(custIds[i]).trim()
    const progress = `[${i + 1}/${custIds.length}]`
    
    console.log(`${progress} cust_id ${custId} ì²˜ë¦¬ ì¤‘...`)
    
    const sessionIds = await getSessionIdsForCustId(custId, sessionLimitPerUser)
    
    if (sessionIds.length > 0) {
      sessionIds.forEach(id => allSessionIds.add(id))
      custIdStats[custId] = sessionIds.length
      console.log(`  âœ… ${sessionIds.length}ê°œ ì„¸ì…˜ ID ë°œê²¬ (ëˆ„ì : ${allSessionIds.size}ê°œ)`)
    } else {
      custIdStats[custId] = 0
      console.log(`  âš ï¸  ì„¸ì…˜ ID ì—†ìŒ`)
    }
    
    // Rate limit ë°©ì§€ (ìœ ì € ê°„ ë”œë ˆì´)
    if (i < custIds.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 500))
    }
  }
  
  const uniqueSessionIds = Array.from(allSessionIds)
  console.log(`\nâœ… [1ë‹¨ê³„ ì™„ë£Œ] ì´ ${uniqueSessionIds.length}ê°œì˜ ê³ ìœ  ì„¸ì…˜ ID ìˆ˜ì§‘`)
  
  // 2. ëª¨ë“  ì„¸ì…˜ IDë¥¼ ë°°ì¹˜ë¡œ ë‚˜ëˆ ì„œ ìˆ˜ì§‘
  console.log(`\nğŸ“¦ [2ë‹¨ê³„] ëª¨ë“  ì„¸ì…˜ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`)
  let totalCollected = 0
  let totalFailed = 0
  const errors = []
  
  for (let i = 0; i < uniqueSessionIds.length; i += batchSize) {
    const batch = uniqueSessionIds.slice(i, i + batchSize)
    const batchNum = Math.floor(i / batchSize) + 1
    const totalBatches = Math.ceil(uniqueSessionIds.length / batchSize)
    
    console.log(`\nğŸ“¦ [ë°°ì¹˜ ${batchNum}/${totalBatches}] ${batch.length}ê°œ ì„¸ì…˜ ìˆ˜ì§‘ ì¤‘...`)
    
    try {
      const collectRes = await fetch('/api/iracing/ml/collect-training-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subsessionIds: batch })
      })
      
      const result = await collectRes.json()
      
      if (result.success) {
        totalCollected += result.totalCollected || 0
        totalFailed += result.totalFailed || 0
        
        if (result.errors && result.errors.length > 0) {
          errors.push(...result.errors)
        }
        
        console.log(`   âœ… ìˆ˜ì§‘ ì™„ë£Œ: ${result.totalCollected}ê°œ ë ˆì½”ë“œ (ì‹¤íŒ¨: ${result.totalFailed})`)
      } else {
        console.error(`   âŒ ìˆ˜ì§‘ ì‹¤íŒ¨:`, result)
        totalFailed += batch.length
      }
    } catch (error) {
      console.error(`   âŒ ë°°ì¹˜ ${batchNum} ì—ëŸ¬:`, error)
      totalFailed += batch.length
      errors.push(`ë°°ì¹˜ ${batchNum}: ${error.message}`)
    }
    
    // Rate limit ë°©ì§€ (ë°°ì¹˜ ê°„ ë”œë ˆì´)
    if (i + batchSize < uniqueSessionIds.length) {
      console.log(`   â³ 2ì´ˆ ëŒ€ê¸° ì¤‘...`)
      await new Promise(resolve => setTimeout(resolve, 2000))
    }
  }
  
  // 3. ìµœì¢… ê²°ê³¼
  console.log(`\nğŸ‰ [ìˆ˜ì§‘ ì™„ë£Œ]`)
  console.log(`   ì´ cust_id: ${custIds.length}ê°œ`)
  console.log(`   ì´ ê³ ìœ  ì„¸ì…˜: ${uniqueSessionIds.length}ê°œ`)
  console.log(`   ìˆ˜ì§‘ëœ ë ˆì½”ë“œ: ${totalCollected}ê°œ`)
  console.log(`   ì‹¤íŒ¨í•œ ì„¸ì…˜: ${totalFailed}ê°œ`)
  
  const usersWithSessions = Object.values(custIdStats).filter(count => count > 0).length
  console.log(`   ì„¸ì…˜ì´ ìˆëŠ” ìœ ì €: ${usersWithSessions}/${custIds.length}ëª…`)
  
  if (errors.length > 0) {
    console.log(`   ì—ëŸ¬ ëª©ë¡ (ìµœëŒ€ 10ê°œ):`, errors.slice(0, 10))
  }
  
  return {
    totalCustIds: custIds.length,
    totalSessions: uniqueSessionIds.length,
    totalCollected,
    totalFailed,
    usersWithSessions,
    errors: errors.length > 0 ? errors : undefined
  }
}

// ì‚¬ìš©ë²•:
// collectAllTrainingData()  // ê¸°ë³¸ê°’: KOREAN_USER_IDS ì „ì²´
// collectAllTrainingData(['814119', '1060971'], 5, 50)  // íŠ¹ì • cust_idë§Œ, ë°°ì¹˜ í¬ê¸°, ìœ ì €ë‹¹ ì„¸ì…˜ ì œí•œ

